%macro heavyDrinking(out=heavyDrinking, cchs_data=, demographics=, adultsOnly=true);%local out cchs_data demographics adultsOnly;  %validate(data=&cchs_data,include=&demographics) data &out; set &cchs_data.(keep=ont_id alc_020 dhh_age &demographics); select(alc_020); when(3,4,5,6) heavyDrinking = 1; when(1,2,96) heavyDrinking = 0; otherwise heavyDrinking = .; end; %if %upcase(&adultsOnly) = TRUE %then %do; if dhh_age < 19 then do; heavyDrinking = .; exclude = 1; end;%end;%else %if %upcase(&adultsOnly) = FALSE %then %do; %put ======================================; %put Population exclusion was not applied; %put ======================================;%end;%else %do; %put ======================================; %put The following error occurred:; %put Valid options for adultsOnly are TRUE or FALSE.; %put Please review and try again.; %put The macro will stop execution.; %put ======================================; %abort;%end;run;%mend heavyDrinking;
%macro lowRiskDrinking(out=lowRiskDrinking, cchs_data=, demographics=, adultsOnly=true);%local out cchs_data demographics adultsOnly;  %validate(data=&cchs_data,include=&demographics) data &out; set &cchs_data.(keep=ont_id doalw alc_005 alc_010 alw: dhh_age dhh_sex &demographics);  if DOALW = 2 then ALWDVLTR = 6; else if ALC_005 = 2 then ALWDVLTR = 6; else if ALC_005 IN (7, 8, 9) or ALC_010 IN (7, 8, 9) or ALW_005 IN (7, 8, 9) or ALW_010 IN (997, 998, 999) or ALW_015 IN (997, 998, 999) or ALW_020 IN (997, 998, 999) or ALW_025 IN (997, 998, 999) or ALW_030 IN (997, 998, 999) or ALW_035 IN (997, 998, 999) or ALW_040 IN (997, 998, 999) then ALWDVLTR = 9; else if (DHH_SEX = 1 and (ALW_010 in (4:995) or ALW_015 in (4:995) or ALW_020 in (4:995) or ALW_025 in (4:995) or ALW_030 in (4:995) or ALW_035 in (4:995) or ALW_040 in (4:995) or ALWDVWKY in (16:995))) OR (DHH_SEX = 2 and (ALW_010 in (3:995) or ALW_015 in (3:995) or ALW_020 in (3:995) or ALW_025 in (3:995) or ALW_030 in (3:995) or ALW_035 in (3:995) or ALW_040 in (3:995) or ALWDVWKY in (11:995))) then ALWDVLTR = 1; else if (ALW_005 = 2 or ALC_010 = 2 or (DHH_SEX = 1 and ALW_010 =< 3 and ALW_015 =< 3 and ALW_020 =< 3 and ALW_025 =< 3 and ALW_030 =< 3 and ALW_035 =< 3 and ALW_040 =< 3 and ALWDVWKY <= 15)) OR (DHH_SEX = 2 and ALW_010 =< 2 and ALW_015 =< 2 and ALW_020 =< 2 and ALW_025 =< 2 and ALW_030 =< 2 and ALW_035 =< 2 and ALW_040 =< 2 and ALWDVWKY <= 10) then ALWDVLTR = 2; select(alwdvltr); when(1) lowRiskDrinking = 0; when(2,6) lowRiskDrinking = 1; when(9) lowRiskDrinking = .; end; %if %upcase(&adultsOnly) = TRUE %then %do; if dhh_age < 19 then do; lowRiskDrinking = .; exclude = 1; end;%end;%else %if %upcase(&adultsOnly) = FALSE %then %do; %put ======================================; %put Population exclusion was not applied; %put ======================================;%end;%else %do; %put ======================================; %put The following error occurred:; %put Valid options for adultsOnly are TRUE or FALSE.; %put Please review and try again.; %put The macro will stop execution.; %put ======================================; %abort;%end;run;%mend lowRiskDrinking;
%macro mergeBootWt(out=,analysis_data=,boot_data=);  %local rc ds hasExclude bs_msg wt_msg analysis_data boot_data out; %let ds = %sysfunc(open(&analysis_data)); %let hasExclude = %sysfunc(varnum(&ds,EXCLUDE)); %let rc = %sysfunc(close(&ds)); %if &hasExclude ne 0 %then %do; %let bs_msg = A population exclusion was applied to the sample weight.; %let wgt_msg = Use the variable excwgt in all PROC steps related to this population.; %end; %else %do; %let bs_msg = No population exclusions were applied.; %let wgt_msg = Use the variable fwgt in all PROC steps. No addtional weight variables were created.; %end;  proc sort data=&analysis_data; by ont_id; run; proc sort data=&boot_data; by ont_id; run;  data &out; merge &analysis_data &boot_data; by ont_id; %if &hasExclude %then %do; if exclude then excwgt = .; else excwgt = fwgt; %end; run; %put ===============================; %put &bs_msg; %put &wgt_msg; %put ===============================;%mend mergeBootWt;
%macro validate(data=,include=);%local data include;%if %length(&data)=0 %then %do; %let _varflag=E; %let _varmsg= A dataset name is required for parameter OUT!; %goto err_exit;%end;%else %do; %let _dsid=%sysfunc(exist(&data,data));  %if &_dsid=0 %then %do; %let _varflag=E; %let _varmsg= The dataset &data does not exist!; %goto err_exit; %end;%end;%if %length(&include) ne 0 %then %do; %let _dsid=%sysfunc(open(&data));  %local count this_var; %let count=1; %let this_var = %qscan(&include,&count,%str( )); %do %while(&this_var ne); %let _varnum=%sysfunc(varnum(&_dsid,&this_var)); %if &_varnum=0 %then %do;  %let _varflag=E; %let _varmsg= The variable &this_var does not exits in the dataset &data.!; %goto err_exit; %end; %let count = %eval(&count+1); %let this_var = %qscan(&demographics,&count,%str( )); %end;%end;%goto clean_exit;%err_exit:  %put ====================================================; %put The following error occurred while running the macro:; %put &_varmsg; %put; %put Please review input and try again.; %put; %put The macro will stop execution.; %put ====================================================;  %abort;%clean_exit: %put ====================================================; %put No invalid parameters were detected.; %put The macro will continue dummy coding.; %put ====================================================;%mend validate;